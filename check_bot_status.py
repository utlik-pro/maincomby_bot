#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ Telegram –±–æ—Ç–∞
"""
import os
import sys
import asyncio
import aiohttp
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å
sys.path.insert(0, str(Path(__file__).parent))

from app.config import load_settings


async def check_bot_status():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Telegram API"""
    settings = load_settings()

    if not settings.bot_token or settings.bot_token == "123456:REPLACE_ME":
        print("‚ùå –û—à–∏–±–∫–∞: BOT_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")
        return False

    url = f"https://api.telegram.org/bot{settings.bot_token}/getMe"

    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(url) as response:
                if response.status == 200:
                    data = await response.json()
                    if data.get("ok"):
                        bot_info = data.get("result", {})
                        print("‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!")
                        print(f"   –ò–º—è: {bot_info.get('first_name')}")
                        print(f"   Username: @{bot_info.get('username')}")
                        print(f"   ID: {bot_info.get('id')}")
                        return True
                    else:
                        print(f"‚ùå –û—à–∏–±–∫–∞ API: {data}")
                        return False
                else:
                    print(f"‚ùå HTTP {response.status}: {await response.text()}")
                    return False
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        return False


async def check_webhook_info():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ webhook (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)"""
    settings = load_settings()
    url = f"https://api.telegram.org/bot{settings.bot_token}/getWebhookInfo"

    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(url) as response:
                if response.status == 200:
                    data = await response.json()
                    if data.get("ok"):
                        webhook_info = data.get("result", {})
                        webhook_url = webhook_info.get("url", "")

                        if webhook_url:
                            print(f"\nüì° –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: Webhook")
                            print(f"   URL: {webhook_url}")
                            print(f"   Pending updates: {webhook_info.get('pending_update_count', 0)}")
                            if webhook_info.get('last_error_message'):
                                print(f"   ‚ö†Ô∏è  –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {webhook_info.get('last_error_message')}")
                        else:
                            print(f"\nüì° –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: Long Polling (–∫–∞–∫ –≤ –∫–æ–¥–µ)")
                        return True
    except Exception as e:
        print(f"‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å webhook info: {e}")

    return False


async def main():
    print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞...\n")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env
    if not os.path.exists(".env"):
        print("‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .env.example –∫–∞–∫ —à–∞–±–ª–æ–Ω.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞
    bot_ok = await check_bot_status()

    if bot_ok:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º webhook info
        await check_webhook_info()

        print("\n‚úÖ –ë–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ Telegram API")
        print("   –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:")
        print("   1. –ó–∞–ø—É—â–µ–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ Railway")
        print("   2. –õ–æ–≥–∏ –≤ Railway Dashboard")
        print("   3. –î–æ–±–∞–≤–ª–µ–Ω –ª–∏ –±–æ—Ç –≤ –≥—Ä—É–ø–ø—É –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
    else:
        print("\n‚ùå –ë–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ BOT_TOKEN –≤ .env —Ñ–∞–π–ª–µ")


if __name__ == "__main__":
    asyncio.run(main())
